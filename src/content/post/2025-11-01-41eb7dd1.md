---
title: "self-hostedなrenovateでself-hostedなnpm packageを管理するには`exposeAllEnv`が必要みたい"
date: 2025-11-01
topics:
  - renovate
  - gitlab-ci
description: ""
type: tech
---

self-hostedなgitlabでnpm packageを公開していて、そのパッケージを使うrepositoryにrenovateが導入されている場合、当然そのパッケージも管理したい。

npmrcに以下のように書けば`NPM_TOKEN`の環境変数を読んで`@scope`のパッケージ探しにいってくれる。

```ini
@scope:registry=https://gitlab.example.com/api/v4/projects/<project_id>/packages/npm/
//gitlab.example.com/api/v4/projects/<project_id>/packages/npm/:_authToken="${NPM_TOKEN}"
```

ただ、renovateは`exposeAllEnv`を指定しないとこれを使えない。

リポジトリにある`.npmrc`は[lib/modules/manager/npm/extract/index.ts#L92+L115](https://github.com/renovatebot/renovate/blob/f33076854f017ee2d247fc29921fd56da6ac8aaa/lib/modules/manager/npm/extract/index.ts#L92+L115)あたりで取得される。

これの直後に各行に対して`${VAR}`形式のmatchをしている。

[lib/modules/manager/npm/extract/index.ts#L116](https://github.com/renovatebot/renovate/blob/f33076854f017ee2d247fc29921fd56da6ac8aaa/lib/modules/manager/npm/extract/index.ts#L116)

ここで`//gitlab.example.com...`の行が消えてしまい、パッケージの取得でエラー(404, 401)になってしまう。

`exposeAllEnv`を`false`のままやるには`renovate.json`に`npmrc`を書いてやる必要があるが、`.npmrc`と`renovate.json`の`npmrc`フィールドで2重管理になってしまう。

また、これの環境変数を置換してやらないといけないが、`RENOVATE_NPM_TOKEN`を指定してやればいけるはず。

しかし、ログで`resolvedConfig.npmToken`, `resolvedConfig.npmrc`があるのにもかかわらず、[lib/workers/repository/init/merge.ts#L321](https://github.com/renovatebot/renovate/blob/f33076854f017ee2d247fc29921fd56da6ac8aaa/lib/workers/repository/init/merge.ts#L321)の処理がログにでてこない。

なぜだろう?

とりあえずは`.gitlab-ci.yaml`で`RENOVATE_EXPOSE_ALL_ENV`を指定すれば動くのでこれでいこうかな。

